<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no" name="viewport"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <title>AlvaAR Camera</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            font-family: 'Helvetica', sans-serif;
            overflow: hidden;
            background: #000;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
            display: block;
            overflow: hidden;
            line-height: 0;
        }

        #container > * {
            position: absolute;
            display: block;
            user-select: none;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            animation: fadeIn 1.2s;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        #container > video {
            object-fit: cover;
            object-position: 50% 50%;
        }

        #splash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 1;
        }

        #overlay {
            position: absolute;
            font-size: 16px;
            z-index: 2;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.5);
        }

        #overlay::before{
            position: absolute;
            width: 100%;
            white-space: pre-wrap;
            content: "Please allow access \A to your camera.";
            top:calc(50% + 50px);
            text-align: center;
            color: #949494;
        }

        #overlay button {
            background: transparent;
            border: 1px solid rgb(255, 255, 255);
            border-radius: 4px;
            color: #ffffff;
            padding: 12px 18px;
            text-transform: uppercase;
            cursor: pointer;
        }

        .nav-buttons {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .nav-buttons button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            color: #ffffff;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-buttons button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.8);
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 0.6;
            }
            100% {
                opacity: 1;
            }
        }

        @media screen and (max-device-width: 480px) and (orientation: landscape) {
            #container {
                display: none;
            }

            body::before {
                content: "Rotate device to portrait mode.";
                color: white;
            }
        }

        @media screen and (max-device-width: 480px) and (orientation: portrait) {
            #container {
                display: block;
            }

            body::before {
                content: none;
            }
        }

        /* Screenshot button UI */
        #ui-layer {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 10;
            pointer-events: none;
        }

        #capture-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: #ff4757;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            pointer-events: auto;
        }

        #capture-btn:active {
            transform: scale(0.95);
        }

        /* Í∞êÎèÑ Ï°∞Ï†à Ïä¨ÎùºÏù¥Îçî UI */
        #sensitivity-control {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        #sensitivity-control label {
            color: white;
            font-size: 14px;
        }

        #sensitivity-control input[type="range"] {
            width: 150px;
        }

        #sensitivity-value {
            color: #4ECDC4;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="nav-buttons">
    <button onclick="location.href='test_1.html'">test_1</button>
</div>
<div id="container"></div>
<div id="overlay">
    <button id="start_button">Start</button>
    <div id="splash"></div>
</div>
<div id="ui-layer">
    <button id="capture-btn">üì∏</button>
</div>

<!-- Í∞êÎèÑ Ï°∞Ï†à UI -->
<div id="sensitivity-control">
    <label>Sensitivity: <span id="sensitivity-value">0.1</span></label>
    <input type="range" id="sensitivity-slider" min="0.02" max="0.5" step="0.02" value="0.1">
</div>

<script type="module">
    import { Stats } from "./assets/stats.js";
    import { AlvaAR } from './assets/alva_ar.js';
    import { ARCamView } from "./assets/view.js";
    import { Camera, onFrame, resize2cover } from "./assets/utils.js";

    function main()
    {
        const config = {
            video: {
                facingMode: 'environment',
                aspectRatio: 16 / 9,
                width: { ideal: 1280 }
            },
            audio: false
        }

        const $container = document.getElementById( 'container' );
        const $view = document.createElement( 'div' );
        const $canvas = document.createElement( 'canvas' );
        const $overlay = document.getElementById( 'overlay' );
        const $start = document.getElementById( 'start_button' );
        const $splash = document.getElementById( 'splash' );
        const splashFadeTime = 800;

        $splash.style.transition = `opacity ${ splashFadeTime / 1000 }s ease`;
        $splash.style.opacity = 0;

        // ========================================
        // Í∞êÎèÑ Ï°∞Ï†à ÏÑ§Ï†ï
        // ========================================
        // Í∞íÏù¥ ÎÇÆÏùÑÏàòÎ°ù Îçî Î∂ÄÎìúÎüΩÍ≥† ÎäêÎ¶¨Í≤å Î∞òÏùë
        // 0.02 = Îß§Ïö∞ ÎäêÎ¶º (Î∂ÄÎìúÎü¨ÏõÄ)
        // 0.1 = Í∏∞Î≥∏Í∞í
        // 0.5 = Îπ†Î¶Ñ (ÏõêÎ≥∏Ïóê Í∞ÄÍπåÏõÄ)
        // 1.0 = Ïä§Î¨¥Îî© ÏóÜÏùå (ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú)
        let SMOOTHING_FACTOR = 0.1;

        // Ïä¨ÎùºÏù¥Îçî Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
        const $slider = document.getElementById('sensitivity-slider');
        const $value = document.getElementById('sensitivity-value');

        $slider.addEventListener('input', (e) => {
            SMOOTHING_FACTOR = parseFloat(e.target.value);
            $value.textContent = SMOOTHING_FACTOR.toFixed(2);
        });

        async function demo( media )
        {
            const $video = media.el;

            const size = resize2cover( $video.videoWidth, $video.videoHeight, $container.clientWidth, $container.clientHeight );

            $canvas.width = $container.clientWidth;
            $canvas.height = $container.clientHeight;
            $video.style.width = size.width + 'px';
            $video.style.height = size.height + 'px';

            const ctx = $canvas.getContext( '2d', { alpha: false, desynchronized: true } );
            const alva = await AlvaAR.Initialize( $canvas.width, $canvas.height );
            const view = new ARCamView( $view, $canvas.width, $canvas.height );

            Stats.add( 'total' );
            Stats.add( 'video' );
            Stats.add( 'slam' );

            $container.appendChild( $canvas );
            $container.appendChild( $view );

            document.body.appendChild( Stats.el );
            document.body.addEventListener( "click", () => alva.reset(), false );

            // ========================================
            // Ìè¨Ï¶à Ïä§Î¨¥Îî© ÏãúÏä§ÌÖú
            // ========================================
            let smoothedPose = null;

            // ÏÑ†Ìòï Î≥¥Í∞Ñ Ìï®Ïàò
            function lerp(a, b, t) {
                return a + (b - a) * t;
            }

            // Ìè¨Ï¶à Ïä§Î¨¥Îî© Ï†ÅÏö©
            function smoothPose(newPose) {
                if (!smoothedPose) {
                    // Ï≤´ Î≤àÏß∏ Ìè¨Ï¶àÎäî Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                    smoothedPose = JSON.parse(JSON.stringify(newPose));
                    return smoothedPose;
                }

                // position Ïä§Î¨¥Îî©
                if (newPose.position && smoothedPose.position) {
                    for (let i = 0; i < newPose.position.length; i++) {
                        smoothedPose.position[i] = lerp(
                            smoothedPose.position[i],
                            newPose.position[i],
                            SMOOTHING_FACTOR
                        );
                    }
                }

                // rotation Ïä§Î¨¥Îî©
                if (newPose.rotation && smoothedPose.rotation) {
                    for (let i = 0; i < newPose.rotation.length; i++) {
                        smoothedPose.rotation[i] = lerp(
                            smoothedPose.rotation[i],
                            newPose.rotation[i],
                            SMOOTHING_FACTOR
                        );
                    }
                }

                // matrix Ïä§Î¨¥Îî© (ÏûàÎäî Í≤ΩÏö∞)
                if (newPose.matrix && smoothedPose.matrix) {
                    for (let i = 0; i < newPose.matrix.length; i++) {
                        smoothedPose.matrix[i] = lerp(
                            smoothedPose.matrix[i],
                            newPose.matrix[i],
                            SMOOTHING_FACTOR
                        );
                    }
                }

                return smoothedPose;
            }

            // Screenshot capture function
            function takeScreenshot(event) {
                event.stopPropagation();

                const captureCanvas = document.createElement('canvas');
                const width = $container.clientWidth;
                const height = $container.clientHeight;

                captureCanvas.width = width;
                captureCanvas.height = height;
                const captureCtx = captureCanvas.getContext('2d');

                captureCtx.drawImage($canvas, 0, 0, width, height);

                const viewCanvas = $view.querySelector('canvas');
                if (viewCanvas) {
                    captureCtx.drawImage(viewCanvas, 0, 0, width, height);
                }

                const dataURL = captureCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `ar-capture-${Date.now()}.png`;
                link.href = dataURL;
                link.click();
            }

            const $captureBtn = document.getElementById('capture-btn');
            if ($captureBtn) {
                $captureBtn.addEventListener('click', takeScreenshot);
            }

            onFrame( () =>
            {
                Stats.next();
                Stats.start( 'total' );

                ctx.clearRect( 0, 0, $canvas.width, $canvas.height );

                if( !document['hidden'] )
                {
                    Stats.start( 'video' );
                    ctx.drawImage( $video, 0, 0, $video.videoWidth, $video.videoHeight, size.x, size.y, size.width, size.height );
                    const frame = ctx.getImageData( 0, 0, $canvas.width, $canvas.height );
                    Stats.stop( 'video' );

                    Stats.start( 'slam' );
                    const pose = alva.findCameraPose( frame );
                    Stats.stop( 'slam' );

                    if( pose )
                    {
                        // Ïä§Î¨¥Îî©Îêú Ìè¨Ï¶à Ï†ÅÏö©
                        const smoothed = smoothPose(pose);
                        view.updateCameraPose( smoothed );
                    }
                    else
                    {
                        view.lostCamera();
                        // Ìä∏ÎûòÌÇπ ÏûÉÏúºÎ©¥ Ïä§Î¨¥Îî© Î¶¨ÏÖã
                        smoothedPose = null;

                        const dots = alva.getFramePoints();

                        for( const p of dots )
                        {
                            ctx.fillStyle = 'white';
                            ctx.fillRect( p.x, p.y, 2, 2 );
                        }
                    }
                }

                Stats.stop( 'total' );
                Stats.render();

                return true;
            }, 30 );
        }

        setTimeout( () =>
        {
            $splash.remove();

            $start.addEventListener( 'click', () =>
            {
                $overlay.remove();

                Camera.Initialize( config ).then( media => demo( media ) ).catch( error => alert( 'Camera ' + error ) );

            }, { once: true } );

        }, splashFadeTime );
    }

    window.addEventListener( 'load', main );
</script>
</body>
</html>