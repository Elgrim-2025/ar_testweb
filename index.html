<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no" name="viewport"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <title>AlvaAR Camera - IMU + Billboard</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            font-family: 'Helvetica', sans-serif;
            overflow: hidden;
            background: #000;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
            display: block;
            overflow: hidden;
            line-height: 0;
        }

        #container > * {
            position: absolute;
            display: block;
            user-select: none;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            animation: fadeIn 1.2s;

            /* üîß Chrome ÍπúÎπ°ÏûÑ Î∞©ÏßÄ: Î∏åÎùºÏö∞Ï†Ä Ïª¥Ìè¨ÏßÄÌåÖ Î†àÏù¥Ïñ¥ Î∂ÑÎ¶¨ */
            will-change: transform;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;

            /* üîß Chrome ÍπúÎπ°ÏûÑ Î∞©ÏßÄ: Canvas Î†àÏù¥Ïñ¥ ÏµúÏ†ÅÌôî */
            will-change: transform;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        #container > video {
            object-fit: cover;
            object-position: 50% 50%;
        }

        #splash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 1;
        }

        #overlay {
            position: absolute;
            font-size: 16px;
            z-index: 2;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.5);
        }

        #overlay::before{
            position: absolute;
            width: 100%;
            white-space: pre-wrap;
            content: "Please allow access \A to your camera and motion sensor.";
            top:calc(50% + 50px);
            text-align: center;
            color: #949494;
        }

        #overlay button {
            background: transparent;
            border: 1px solid rgb(255, 255, 255);
            border-radius: 4px;
            color: #ffffff;
            padding: 12px 18px;
            text-transform: uppercase;
            cursor: pointer;
        }

        /* Screenshot button UI */
        #ui-layer {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 10;
            pointer-events: none;
        }

        #capture-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: #ff4757;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            pointer-events: auto;
        }

        #capture-btn:active {
            transform: scale(0.95);
        }

        /* IMU Status Indicator */
        #imu-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }

        #imu-status.active {
            display: block;
            background: rgba(0, 255, 100, 0.3);
            border: 1px solid rgba(0, 255, 100, 0.6);
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 0.6;
            }
            100% {
                opacity: 1;
            }
        }

        @media screen and (max-device-width: 480px) and (orientation: landscape) {
            #container {
                display: none;
            }

            body::before {
                content: "Rotate device to portrait mode.";
                color: white;
            }
        }

        @media screen and (max-device-width: 480px) and (orientation: portrait) {
            #container {
                display: block;
            }

            body::before {
                content: none;
            }
        }
    </style>
</head>
<body>
<div id="container"></div>
<div id="overlay">
    <button id="start_button">Start</button>
    <div id="splash"></div>
</div>
<div id="ui-layer">
    <button id="capture-btn">üì∏</button>
</div>
<div id="imu-status">IMU Active</div>

<script type="module">
    import { Stats } from "./assets/stats.js";
    import { AlvaAR } from './assets/alva_ar.js';
    import { ARCamView } from "./assets/view.js";
    import { Camera, onFrame, resize2cover } from "./assets/utils.js";
    import { IMU } from "./assets/imu.js";

    function main()
    {
        const config = {
            video: {
                facingMode: 'environment',
                aspectRatio: 16 / 9,
                width: { ideal: 1280 }
            },
            audio: false
        }

        const $container = document.getElementById( 'container' );
        const $view = document.createElement( 'div' );
        const $canvas = document.createElement( 'canvas' );
        const $overlay = document.getElementById( 'overlay' );
        const $start = document.getElementById( 'start_button' );
        const $splash = document.getElementById( 'splash' );
        const $imuStatus = document.getElementById( 'imu-status' );
        const splashFadeTime = 800;

        $splash.style.transition = `opacity ${ splashFadeTime / 1000 }s ease`;
        $splash.style.opacity = 0;

        async function demo( media, imu )
        {
            const $video = media.el;

            const size = resize2cover( $video.videoWidth, $video.videoHeight, $container.clientWidth, $container.clientHeight );

            $canvas.width = $container.clientWidth;
            $canvas.height = $container.clientHeight;
            $video.style.width = size.width + 'px';
            $video.style.height = size.height + 'px';

            const ctx = $canvas.getContext( '2d', { alpha: false, desynchronized: true } );
            const alva = await AlvaAR.Initialize( $canvas.width, $canvas.height );
            const view = new ARCamView( $view, $canvas.width, $canvas.height );

            Stats.add( 'total' );
            Stats.add( 'video' );
            Stats.add( 'slam' );

            $container.appendChild( $canvas );
            $container.appendChild( $view );

            document.body.appendChild( Stats.el );

            // IMU ÏÉÅÌÉú ÌëúÏãú
            if (imu) {
                $imuStatus.classList.add('active');
            }

            // üîß Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤ò Ìï®Ïàò (preserveDrawingBuffer: false ÎåÄÏùë)
            function takeScreenshot(event) {
                event.stopPropagation();

                const captureCanvas = document.createElement('canvas');
                const width = $container.clientWidth;
                const height = $container.clientHeight;

                captureCanvas.width = width;
                captureCanvas.height = height;
                const captureCtx = captureCanvas.getContext('2d');

                // 1. Ïπ¥Î©îÎùº ÌîºÎìú Í∑∏Î¶¨Í∏∞
                captureCtx.drawImage($canvas, 0, 0, width, height);

                // 2. Three.js Î†åÎçîÎü¨Î•º ÏûÑÏãúÎ°ú preserveDrawingBuffer Î™®ÎìúÎ°ú Ìïú ÌîÑÎ†àÏûÑ Î†åÎçîÎßÅ
                const viewCanvas = $view.querySelector('canvas');
                if (viewCanvas) {
                    // Three.js Ï∫îÎ≤ÑÏä§Î•º ÏßÅÏ†ë Î≥µÏÇ¨ (Ïù¥ÎØ∏ Î†åÎçîÎßÅÎêú ÏÉÅÌÉú)
                    captureCtx.drawImage(viewCanvas, 0, 0, width, height);
                }

                // 3. Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú
                const dataURL = captureCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `ar-capture-${Date.now()}.png`;
                link.href = dataURL;
                link.click();
            }

            // Ïä§ÌÅ¨Î¶∞ÏÉ∑ Î≤ÑÌäº Ïó∞Í≤∞
            const $captureBtn = document.getElementById('capture-btn');
            if ($captureBtn) {
                $captureBtn.addEventListener('click', takeScreenshot);
            }

            // ÎçîÎ∏î ÌÅ¥Î¶≠ÏúºÎ°ú SLAM Î¶¨ÏÖã
            document.body.addEventListener( "dblclick", () => alva.reset(), false );

            // ‚≠ê Î©îÏù∏ Î†åÎçîÎßÅ Î£®ÌîÑ
            onFrame( () =>
            {
                Stats.next();
                Stats.start( 'total' );

                ctx.clearRect( 0, 0, $canvas.width, $canvas.height );

                if( !document['hidden'] )
                {
                    Stats.start( 'video' );
                    ctx.drawImage( $video, 0, 0, $video.videoWidth, $video.videoHeight, size.x, size.y, size.width, size.height );
                    const frame = ctx.getImageData( 0, 0, $canvas.width, $canvas.height );
                    Stats.stop( 'video' );

                    Stats.start( 'slam' );

                    // üéØ IMU ÏÑºÏÑú ÌÜµÌï©: IMUÍ∞Ä ÏûàÏúºÎ©¥ ÏÑºÏÑú ÏúµÌï© Î™®Îìú ÏÇ¨Ïö©
                    let pose;
                    if (imu) {
                        pose = alva.findCameraPoseWithIMU( frame, imu.orientation, imu.motion );
                        imu.clear(); // ÏÇ¨Ïö©Ìïú Î™®ÏÖò Îç∞Ïù¥ÌÑ∞ ÌÅ¥Î¶¨Ïñ¥
                    } else {
                        pose = alva.findCameraPose( frame );
                    }

                    Stats.stop( 'slam' );

                    if( pose )
                    {
                        view.updateCameraPose( pose );
                    }
                    else
                    {
                        view.lostCamera();

                        const dots = alva.getFramePoints();

                        for( const p of dots )
                        {
                            ctx.fillStyle = 'white';
                            ctx.fillRect( p.x, p.y, 2, 2 );
                        }
                    }
                }

                Stats.stop( 'total' );
                Stats.render();
                return true;
            }, 30 );
        }

        setTimeout( () =>
        {
            $splash.remove();

            $start.addEventListener( 'click', async () =>
            {
                try {
                    $overlay.remove();

                    // üéØ IMU Ï¥àÍ∏∞Ìôî (Í∂åÌïú ÏöîÏ≤≠ Ìè¨Ìï®)
                    let imu = null;
                    try {
                        imu = await IMU.Initialize();
                        console.log('‚úÖ IMU initialized successfully');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è IMU not available:', error);
                        // IMU ÏóÜÏù¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
                    }

                    // Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî
                    const media = await Camera.Initialize( config );

                    // AR Îç∞Î™® ÏãúÏûë
                    await demo( media, imu );

                } catch( error ) {
                    alert( 'Error: ' + error );
                }

            }, { once: true } );

        }, splashFadeTime );
    }

    window.addEventListener( 'load', main );
</script>
</body>
</html>
