<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Video Texture Demo</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
        }
        #ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #camera-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        #ui-layer {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 3;
            pointer-events: auto;
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: #ff4757;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        #play-btn { background-color: #2ed573; }
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            font-family: sans-serif;
            font-size: 14px;
            z-index: 3;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

<div id="ar-container">
    <video id="camera-feed" autoplay playsinline muted></video>
    <canvas id="three-canvas"></canvas>
    <div id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
    <div id="ui-layer">
        <button id="play-btn">â–¶ï¸ ì´í™íŠ¸ ì¬ìƒ</button>
        <button id="capture-btn">ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·</button>
    </div>
</div>

<script>
    // ==========================================
    // 1. ë³€ìˆ˜ ì„ ì–¸
    // ==========================================
    const cameraVideo = document.getElementById('camera-feed');
    const canvas3D = document.getElementById('three-canvas');
    const captureBtn = document.getElementById('capture-btn');
    const playBtn = document.getElementById('play-btn');
    const statusEl = document.getElementById('status');

    let renderer, scene, camera;
    // [ë³€ê²½] cube ëŒ€ì‹  videoPlane ì‚¬ìš©
    let videoPlane, effectVideo, videoTexture;

    // ==========================================
    // 2. ì¹´ë©”ë¼ ì‹¤í–‰
    // ==========================================
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
                audio: false
            });
            cameraVideo.srcObject = stream;
            updateStatus('ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ');
        } catch (err) {
            updateStatus('ì¹´ë©”ë¼ ì˜¤ë¥˜: ' + err.message);
            console.error("Camera Error:", err);
        }
    }

    // ==========================================
    // 3. [í•µì‹¬] ì´í™íŠ¸ ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ë™ì  ìƒì„±
    // ==========================================
    function createEffectVideo() {
        // HTMLì— ì§ì ‘ ë„£ì§€ ì•Šê³  JSë¡œ ë™ì  ìƒì„±
        effectVideo = document.createElement('video');

        // [í•„ìˆ˜] CORS ì„¤ì • (ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ ì‚¬ìš© ì‹œ)
        effectVideo.crossOrigin = 'anonymous';

        // [í•„ìˆ˜] ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì •ì±… ëŒ€ì‘
        effectVideo.muted = true;
        effectVideo.loop = true;
        effectVideo.playsInline = true;

        // ë¹„ë””ì˜¤ ê²½ë¡œ ì„¤ì • (placeholder)
        effectVideo.src = './custom.webm';

        // ë¹„ë””ì˜¤ ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸
        effectVideo.addEventListener('loadeddata', () => {
            updateStatus('ì´í™íŠ¸ ë¹„ë””ì˜¤ ë¡œë“œ ì™„ë£Œ');
            // í…ìŠ¤ì²˜ ì—…ë°ì´íŠ¸ í•„ìš” ì•Œë¦¼
            if (videoTexture) videoTexture.needsUpdate = true;
        });

        effectVideo.addEventListener('error', (e) => {
            updateStatus('ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨ - ë°ëª¨ íŒ¨í„´ í‘œì‹œ');
            console.warn('Video load error, using fallback');
            createFallbackTexture();
        });

        // ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘
        effectVideo.load();

        return effectVideo;
    }

    // [ë³´ì¡°] ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ í…ìŠ¤ì²˜
    function createFallbackTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 256;
        const ctx = canvas.getContext('2d');

        // ì²´ì»¤ë³´ë“œ íŒ¨í„´ (ë°˜íˆ¬ëª…)
        for (let y = 0; y < 8; y++) {
            for (let x = 0; x < 8; x++) {
                ctx.fillStyle = (x + y) % 2 === 0 ? 'rgba(255,71,87,0.8)' : 'rgba(46,213,115,0.8)';
                ctx.fillRect(x * 32, y * 32, 32, 32);
            }
        }
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 20px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('VIDEO', 128, 128);

        const fallbackTexture = new THREE.CanvasTexture(canvas);
        if (videoPlane) {
            videoPlane.material.map = fallbackTexture;
            videoPlane.material.needsUpdate = true;
        }
    }

    // ==========================================
    // 4. Three.js 3D í™˜ê²½ ì„¤ì •
    // ==========================================
    function initThreeJS() {
        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        renderer = new THREE.WebGLRenderer({
            canvas: canvas3D,
            alpha: true,
            preserveDrawingBuffer: true // [ìœ ì§€] ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ìš©
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // [ë³€ê²½] ì´í™íŠ¸ ë¹„ë””ì˜¤ ìƒì„± ë° VideoTexture ì ìš©
        const video = createEffectVideo();

        // THREE.VideoTexture ìƒì„±
        videoTexture = new THREE.VideoTexture(video);
        videoTexture.minFilter = THREE.LinearFilter;
        videoTexture.magFilter = THREE.LinearFilter;
        videoTexture.format = THREE.RGBAFormat; // [í•µì‹¬] ì•ŒíŒŒ ì±„ë„ ì§€ì›

        // [ë³€ê²½] PlaneGeometryë¡œ ë¹„ë””ì˜¤ í‘œì‹œ
        const geometry = new THREE.PlaneGeometry(2, 2);

        // [í•µì‹¬] ì•ŒíŒŒ ì±„ë„ íˆ¬ëª… ì²˜ë¦¬ë¥¼ ìœ„í•œ MeshBasicMaterial ì„¤ì •
        const material = new THREE.MeshBasicMaterial({
            map: videoTexture,
            transparent: true,        // [í•„ìˆ˜] íˆ¬ëª…ë„ í™œì„±í™”
            side: THREE.DoubleSide,   // [í•„ìˆ˜] ì–‘ë©´ ë Œë”ë§
            alphaTest: 0.1            // ì•ŒíŒŒê°’ ì„ê³„ì¹˜ (ì„ íƒ)
        });

        videoPlane = new THREE.Mesh(geometry, material);
        videoPlane.position.set(0, 0, 2); // z=2 ìœ„ì¹˜ (ì¹´ë©”ë¼ ì•)
        scene.add(videoPlane);

        animate();
    }

    // ë Œë”ë§ ë£¨í”„
    function animate() {
        requestAnimationFrame(animate);

        // [ì„ íƒ] Planeì— ë¶€ë“œëŸ¬ìš´ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
        if (videoPlane) {
            videoPlane.rotation.y = Math.sin(Date.now() * 0.001) * 0.3;
        }

        // VideoTexture ìë™ ì—…ë°ì´íŠ¸ (ì¬ìƒ ì¤‘ì¼ ë•Œ)
        if (videoTexture && effectVideo && !effectVideo.paused) {
            videoTexture.needsUpdate = true;
        }

        renderer.render(scene, camera);
    }

    // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // ==========================================
    // 5. ë¹„ë””ì˜¤ ì¬ìƒ ì œì–´ (ë¸Œë¼ìš°ì € ì •ì±… ëŒ€ì‘)
    // ==========================================
    async function playEffectVideo() {
        if (!effectVideo) return;

        try {
            // [í•µì‹¬] play()ëŠ” Promise ë°˜í™˜ - ì—ëŸ¬ í•¸ë“¤ë§ í•„ìˆ˜
            await effectVideo.play();
            updateStatus('ì´í™íŠ¸ ì¬ìƒ ì¤‘ â–¶ï¸');
            playBtn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
        } catch (err) {
            // ìë™ì¬ìƒ ì°¨ë‹¨ ì‹œ ì‚¬ìš©ì ì¸í„°ë™ì…˜ í•„ìš”
            updateStatus('ì¬ìƒ ì‹¤íŒ¨: ' + err.message);
            console.error('Play error:', err);
        }
    }

    function toggleEffectVideo() {
        if (!effectVideo) return;

        if (effectVideo.paused) {
            playEffectVideo();
        } else {
            effectVideo.pause();
            updateStatus('ì´í™íŠ¸ ì¼ì‹œì •ì§€ â¸ï¸');
            playBtn.textContent = 'â–¶ï¸ ì´í™íŠ¸ ì¬ìƒ';
        }
    }

    // ==========================================
    // 6. ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    // ==========================================
    function takeScreenshot() {
        // ìº¡ì²˜ ì „ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„ (ì²« í´ë¦­ ì‹œ ì¬ìƒ í™œì„±í™”)
        if (effectVideo && effectVideo.paused) {
            playEffectVideo();
        }

        const captureCanvas = document.createElement('canvas');
        const width = window.innerWidth * window.devicePixelRatio;
        const height = window.innerHeight * window.devicePixelRatio;

        captureCanvas.width = width;
        captureCanvas.height = height;
        const ctx = captureCanvas.getContext('2d');

        // ì¹´ë©”ë¼ ë¹„ë””ì˜¤ ê·¸ë¦¬ê¸°
        drawVideoCover(ctx, cameraVideo, width, height);

        // [í˜¸í™˜ì„± ìœ ì§€] WebGL Canvas ê·¸ë¦¬ê¸° (VideoTexture í¬í•¨)
        ctx.drawImage(canvas3D, 0, 0, width, height);

        // ë‹¤ìš´ë¡œë“œ
        const dataURL = captureCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `ar-capture-${Date.now()}.png`;
        link.href = dataURL;
        link.click();

        updateStatus('ìŠ¤í¬ë¦°ìƒ· ì €ì¥ë¨! ğŸ“¸');
    }

    function drawVideoCover(ctx, videoEl, targetW, targetH) {
        const vidW = videoEl.videoWidth || targetW;
        const vidH = videoEl.videoHeight || targetH;
        const targetRatio = targetW / targetH;
        const vidRatio = vidW / vidH;
        let sx, sy, sW, sH;

        if (vidRatio > targetRatio) {
            sH = vidH;
            sW = vidH * targetRatio;
            sx = (vidW - sW) / 2;
            sy = 0;
        } else {
            sW = vidW;
            sH = vidW / targetRatio;
            sx = 0;
            sy = (vidH - sH) / 2;
        }
        ctx.drawImage(videoEl, sx, sy, sW, sH, 0, 0, targetW, targetH);
    }

    function updateStatus(msg) {
        statusEl.textContent = 'ìƒíƒœ: ' + msg;
    }

    // ==========================================
    // 7. ì‹¤í–‰ ì‹œì‘
    // ==========================================
    initThreeJS();
    startCamera();

    playBtn.addEventListener('click', toggleEffectVideo);
    captureBtn.addEventListener('click', takeScreenshot);
</script>
</body>
</html>