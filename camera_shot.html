<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Screenshot Demo (Vanilla JS)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            background-color: #000;
        }

        /* ì»¨í…Œì´ë„ˆ: ë¹„ë””ì˜¤ì™€ 3D ìº”ë²„ìŠ¤ë¥¼ ê²¹ì¹˜ê¸° ìœ„í•¨ */
        #ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* 1. ì¹´ë©”ë¼ ë¹„ë””ì˜¤ (ë°°ê²½) */
        #camera-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* í™”ë©´ ê½‰ ì±„ìš°ê¸° */
            z-index: 1;
        }

        /* 2. 3D ìº”ë²„ìŠ¤ (ì „ê²½) */
        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none; /* í´ë¦­ ì´ë²¤íŠ¸ë¥¼ íˆ¬ê³¼ì‹œì¼œ í•„ìš”ì‹œ ë¹„ë””ì˜¤ ì¡°ì‘ ê°€ëŠ¥í•˜ê²Œ í•¨ */
        }

        /* 3. ìº¡ì²˜ ë²„íŠ¼ UI */
        #ui-layer {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 3;
            pointer-events: auto;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: #ff4757;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.95);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

<div id="ar-container">
    <video id="camera-feed" autoplay playsinline muted></video>

    <canvas id="three-canvas"></canvas>

    <div id="ui-layer">
        <button id="capture-btn">ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· ì°ê¸°</button>
    </div>
</div>

<script>
    // ==========================================
    // 1. ë³€ìˆ˜ ì„ ì–¸ ë° ì´ˆê¸°í™”
    // ==========================================
    const video = document.getElementById('camera-feed');
    const canvas3D = document.getElementById('three-canvas');
    const captureBtn = document.getElementById('capture-btn');
    let renderer, scene, camera, cube;

    // ==========================================
    // 2. ì¹´ë©”ë¼ ì‹¤í–‰ (Camera Setup)
    // ==========================================
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                },
                audio: false
            });
            video.srcObject = stream;
        } catch (err) {
            alert("ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. HTTPSë‚˜ localhostì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
            console.error("Camera Error:", err);
        }
    }

    // ==========================================
    // 3. Three.js 3D í™˜ê²½ ì„¤ì • (WebGL Setup)
    // ==========================================
    function initThreeJS() {
        // Scene ìƒì„±
        scene = new THREE.Scene();

        // Camera ìƒì„±
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        // Renderer ìƒì„±
        renderer = new THREE.WebGLRenderer({
            canvas: canvas3D,
            alpha: true, // [ì¤‘ìš”] ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ í•´ì„œ ë¹„ë””ì˜¤ê°€ ë³´ì´ê²Œ í•¨
            preserveDrawingBuffer: true // [í•µì‹¬] ìº¡ì²˜ë¥¼ ìœ„í•´ ë²„í¼ë¥¼ ì§€ìš°ì§€ ì•ŠìŒ
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio); // ê³ í•´ìƒë„ ì²˜ë¦¬

        // ì˜ˆì œ 3D ë¬¼ì²´ (íšŒì „í•˜ëŠ” íë¸Œ) ì¶”ê°€
        const geometry = new THREE.BoxGeometry();
        const material = new THREE.MeshNormalMaterial({ wireframe: false }); // ìƒ‰ìƒì´ ì˜ˆìœ ì¬ì§ˆ
        cube = new THREE.Mesh(geometry, material);
        scene.add(cube);

        // ì¡°ëª… ì¶”ê°€
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(0, 1, 1);
        scene.add(light);

        animate();
    }

    // ë Œë”ë§ ë£¨í”„
    function animate() {
        requestAnimationFrame(animate);

        // íë¸Œ íšŒì „ ì• ë‹ˆë©”ì´ì…˜
        if (cube) {
            cube.rotation.x += 0.01;
            cube.rotation.y += 0.01;
        }

        renderer.render(scene, camera);
    }

    // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // ==========================================
    // 4. ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ë° í•©ì„± ë¡œì§ (Screenshot Logic)
    // ==========================================
    function takeScreenshot() {
        // A. ì„ì‹œ ìº”ë²„ìŠ¤ ìƒì„± (í˜„ì¬ í™”ë©´ í•´ìƒë„ ê¸°ì¤€)
        const captureCanvas = document.createElement('canvas');
        const width = window.innerWidth * window.devicePixelRatio;
        const height = window.innerHeight * window.devicePixelRatio;

        captureCanvas.width = width;
        captureCanvas.height = height;
        const ctx = captureCanvas.getContext('2d');

        // B. ë¹„ë””ì˜¤ ê·¸ë¦¬ê¸° (object-fit: cover íš¨ê³¼ êµ¬í˜„)
        // ë¹„ë””ì˜¤ì˜ ì‹¤ì œ í¬ê¸°ì™€ í™”ë©´ì˜ ë¹„ìœ¨ì´ ë‹¤ë¥´ë¯€ë¡œ ê³„ì‚°ì´ í•„ìš”í•¨
        drawVideoCover(ctx, video, width, height);

        // C. WebGL Canvas ê·¸ë¦¬ê¸°
        // ì´ë¯¸ í™”ë©´ì— ë Œë”ë§ëœ 3D ìº”ë²„ìŠ¤ë¥¼ ê·¸ëŒ€ë¡œ ìœ„ì— ë®ì–´ì”€
        ctx.drawImage(canvas3D, 0, 0, width, height);

        // D. ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
        const dataURL = captureCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `ar-capture-${Date.now()}.png`;
        link.href = dataURL;
        link.click();
    }

    // [ë³´ì¡° í•¨ìˆ˜] ë¹„ë””ì˜¤ë¥¼ ìº”ë²„ìŠ¤ì— ê½‰ ì°¨ê²Œ(Cover) ê·¸ë¦¬ëŠ” ê³„ì‚° ë¡œì§
    function drawVideoCover(ctx, videoEl, targetW, targetH) {
        const vidW = videoEl.videoWidth;
        const vidH = videoEl.videoHeight;

        const targetRatio = targetW / targetH;
        const vidRatio = vidW / vidH;

        let sx, sy, sW, sH; // ì†ŒìŠ¤(ë¹„ë””ì˜¤)ì—ì„œ ì˜ë¼ë‚¼ ì˜ì—­

        if (vidRatio > targetRatio) {
            // ë¹„ë””ì˜¤ê°€ ë” ë‚©ì‘í•¨ -> ì–‘ì˜†ì„ ìë¦„
            sH = vidH;
            sW = vidH * targetRatio;
            sx = (vidW - sW) / 2;
            sy = 0;
        } else {
            // ë¹„ë””ì˜¤ê°€ ë” ê¸¸ì­‰í•¨ -> ìœ„ì•„ë˜ë¥¼ ìë¦„
            sW = vidW;
            sH = vidW / targetRatio;
            sx = 0;
            sy = (vidH - sH) / 2;
        }

        // ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° (ì¢Œìš°ë°˜ì „ì´ í•„ìš”í•˜ë‹¤ë©´ save/scale/restore ì¶”ê°€)
        ctx.drawImage(videoEl, sx, sy, sW, sH, 0, 0, targetW, targetH);
    }

    // ==========================================
    // 5. ì‹¤í–‰ ì‹œì‘
    // ==========================================
    initThreeJS();
    startCamera();

    captureBtn.addEventListener('click', takeScreenshot);

</script>
</body>
</html>
